%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% University Assignment Title Page 
% LaTeX Template
% Version 1.0 (27/12/12)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% WikiBooks (http://en.wikibooks.org/wiki/LaTeX/Title_Creation)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
% 
% Instructions for using this template:
% This title page is capable of being compiled as is. This is not useful for 
% including it in another document. To do this, you have two options: 
%
% 1) Copy/paste everything between \begin{document} and \end{document} 
% starting at \begin{titlepage} and paste this into another LaTeX file where you 
% want your title page.
% OR
% 2) Remove everything outside the \begin{titlepage} and \end{titlepage} and 
% move this file to the same directory as the LaTeX file you wish to add it to. 
% Then add \input{./title_page_1.tex} to your LaTeX file where you want your
% title page.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\title{Title page with logo}
%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[12pt]{article}
\usepackage[english]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}

% My Packpage 
\usepackage{glossaries}
\usepackage{bm}
\usepackage{mathtools}
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}
\newglossaryentry{latex}
{
    name=latex,
    description={Is a mark up language specially suited 
    for scientific documents}
}
\newacronym{gcd}{GCD}{Greatest Common Divisor}
\makeglossaries
\begin{document}
\begin{titlepage}
\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % Defines a new command for the horizontal lines, change thickness here
\center % Center everything on the page
\textsc{\LARGE The University of California, Los Angeles}\\[1.5cm] % Name of your university/college
\textsc{\Large Robotics Design Capstone}\\[0.5cm] % Major heading such as course name
\textsc{\large EE 183DB }\\[0.5cm] % Minor heading such as course title
\HRule \\[0.4cm]
{ \huge \bfseries Off-center spinning mass controller for Quadcopters}\\[0.4cm] % Title of your document
\HRule \\[1.5cm]
\begin{minipage}{0.4\textwidth}
\begin{flushleft} \large
\emph{Author:}\\
Lin \textsc{Li} % Your name
\\
Angel \textsc{Jimenez} % Your name
\\
Wilson \textsc{Chang} % Your name
\\
Amirali \textsc{Omidfar} % Your name
\end{flushleft}
\end{minipage}
~
\begin{minipage}{0.4\textwidth}
\begin{flushright} \large
\emph{Professor:} \\
Ankur \textsc{Metha} % Supervisor's Name
\end{flushright}
\end{minipage}\\[1cm]
{\large \today}\\[1cm] % Date, change the \today to a set date if you want to be precise
\includegraphics[scale=0.2]{UCLA_Logo.png}\\[1cm] % Include a department/university logo - this will require the graphicx package
%----------------------------------------------------------------------------------------
\vfill % Fill the rest of the page with whitespace
\end{titlepage}
\begin{abstract}
This project is insanely hard...
\end{abstract}
\tableofcontents
\section{Symbols}

\section{Introduction}

\section{Mathematical Model}

\section{Simulation}

\section{Implementation}

\section{Results}

\section{Conclusion}

\section{Reference}



Here is a list of all symbols used in this paper:
\\
\begin{tabular}{c p{1\textwidth}}
  $\bm{p} = \begin{bmatrix}x \\ y \\ z \end{bmatrix}$ & linear position vectors \\
  $\bm{q} = \begin{bmatrix} q_r \\ q_i \\ q_j \\ q_k \end{bmatrix}$ & angular orientation in quaternion \\
  $\bm{F_{T}}$ & thrust force \\
  $\bm{F_{G}}$ & gravitational force \\  
  $\bm{F_{AB}}$ & reaction force acted from A on B \\
  $\bm{\tau_{AB}}$ & reaction torque acted from A on B \\
  $\bm{\tau_{M}}$ & torque generated by the motor \\
  $\bm{\tau_{RF}}$ & torque generated by the reaction force \\  
  $m_A$ & mass of A \\
  $I_A$ & moment of inertial of A \\
  $S_x, C_x, T_x$ & $\sin(x), \cos(x), \tan(x)$ respectively \\
\end{tabular}\\
% \\ \\ \\ \\ \\ \\
% \newpage

\section{Mathematical Derivation}
\subsection{Appendix}
The Quaternion-derived Rotation matrix is defined as follow,
\begin{align*}
  \prescript{O}{B}{R} = R(\bm{q_B}) =
  \begin{bmatrix}
    q_r^2 + q_i^2 - q_j^2 - q_k^2 & 2q_iq_j - 2q_rq_k & 2q_iq_k + 2q_rq_j \\
    2q_iq_j + 2q_rq_k & q_r^2 - q_i^2 + q_j^2 - q_k^2 & 2q_jq_k - 2q_rq_i \\
    2q_iq_k - 2q_rq_j & 2q_jq_k + 2q_rq_i & q_r^2 - q_i^2 - q_j^2 +q_k^2
  \end{bmatrix}
\end{align*}

\subsection{Quadcopter Body Dynamics}
Forces and Torques:
\begin{align*}
  \prescript{B}{}{\bm{F_{T}}} &=
  \begin{bmatrix}
    0 \\ 0 \\ F_{TB}
  \end{bmatrix} \\
  \prescript{O}{}{\bm{F_{GB}}} &=
  \begin{bmatrix}
    0 \\ 0 \\ -m_b g
  \end{bmatrix} \\
  \prescript{O}{}{\bm{F_{CB}}} &=
  \begin{bmatrix}
    F_{CBx} \\ F_{CBy} \\ F_{CBz} 
  \end{bmatrix} \\
  \prescript{B}{}{\bm{\tau_{CB}}} &=
  \begin{bmatrix}
    \tau_{CBx} \\ \tau_{CBy} \\ -\tau_{M} 
  \end{bmatrix}
\end{align*}

Net Force and Torque
\begin{align}
  \prescript{O}{}{\bm{F_{B, net}}} &= \prescript{O}{}{\bm{F_{GB}}} + \prescript{O}{}{\bm{F_{T}}} + \prescript{O}{}{\bm{F_{CB}}} = m_B \prescript{O}{}{\bm{a_B}} \\
  \prescript{O}{}{\bm{\tau_{B, net}}} &= R(\bm{q_B})\prescript{B}{}{\bm{\tau_{CB}}} = \prescript{O}{}{I_B} \prescript{O}{}{\bm{\alpha_B}}
\end{align}

\subsection{Controller Dynamics}
Forces and Torques:
\begin{align*}
  \prescript{O}{}{\bm{F_{BC}}} &=
  \begin{bmatrix}
    F_{BCx} \\ F_{BCy} \\ F_{BCz}
  \end{bmatrix} \\
  \prescript{O}{}{\bm{F_{GC}}} &=
  \begin{bmatrix}
    0 \\ 0 \\ -m_c g
  \end{bmatrix} \\
  \prescript{C}{}{\bm{\tau_{BC}}} &=
  \begin{bmatrix}
    \tau_{BCx} \\ \tau_{BCy} \\ \tau_{M} 
  \end{bmatrix} \\
  \prescript{O}{}{\bm{r_{CB}}} &= R(\bm{q_C}) \begin{bmatrix}
                                   -L_{Mx} \\ 0 \\ -L_{Mz}
                                 \end{bmatrix} \\
  \prescript{O}{}{\bm{\tau_{RF}}} &=  \prescript{O}{}{\bm{r_{CB}}} \times \prescript{O}{}{\bm{F_{BC}}}
\end{align*}
Net Force and Net Torque:
\begin{align}
  \prescript{O}{}{\bm{F_{net, C}}} &= \prescript{O}{}{\bm{F_{BC}}} + \prescript{O}{}{\bm{F_{GC}}} = m_C \prescript{O}{}{\bm{a_C}} \\
  \prescript{O}{}{\bm{\tau_{net, C}}} &= R(\bm{q_C})\prescript{C}{}{\bm{\tau_{BC}}} + \prescript{O}{}{\bm{\tau_{RF}}} = \prescript{O}{}{I_c} \prescript{O}{}{\bm{\alpha_C}}
\end{align}
\subsection{Constraints and Manipulation}
In the derivation below, assume everything is in the inertial frame unless explicitly stated. \par
The two bodies are contrainted (attached together), there are some relationship between the states and the forces between the body and the controller, 
\begin{align}
  \intertext{Let $\bm{p_{sys}} = \bm{p_B}$ and $\bm{q_{sys}} = \bm{q_{B}}$,}
  \begin{bmatrix}
    \bm{p_C} \\
    \bm{q_C}
  \end{bmatrix} &=
  \begin{bmatrix}
    \bm{p_B} + \bm{r_{BC}} \\
    \bm{q_{\theta}}\bm{q_B}
  \end{bmatrix}
  =
  \begin{bmatrix}
    \bm{p_{sys}} + \bm{r_{BC}} \\
    \bm{q_{\theta}}\bm{q_{sys}}
\end{bmatrix}  \\
% First Derivative
  \begin{bmatrix}
    \bm{\dot{p}_C} \\
    \bm{\dot{q}_C}
  \end{bmatrix} &=
  \begin{bmatrix}
    \bm{\dot{p}_{sys}} + \dot{R}(\bm{q_{sys}})\prescript{B}{}{\bm{r_{BC}}} \\
    \bm{q_{\theta}}\bm{\dot{q}_{sys}} + \bm{\dot{q}_{\theta}}\bm{q_{sys}} 
\end{bmatrix} \\
% Second Derivative
  \begin{bmatrix}
    \bm{\ddot{p}_C} \\
    \bm{\ddot{q}_C}
  \end{bmatrix} &=
  \begin{bmatrix}
    \bm{\ddot{p}_{sys}} + \ddot{R}(\bm{q_{sys}})\prescript{B}{}{\bm{r_{BC}}} \\
    \bm{q_{\theta}}\bm{\ddot{q}_{sys}} + 2[\bm{\dot{q_\theta}} \bm{\dot{q}_{sys}}] + \bm{\ddot{q}_{\theta}}\bm{q_{sys}} 
  \end{bmatrix} \\   
  \intertext{Newton's Third Law}
  \prescript{O}{}{\bm{F_{BC}}} &= -\prescript{O}{}{\bm{F_{CB}}} \\
  \prescript{O}{}{\bm{\tau_{BC}}} &= -\prescript{O}{}{\bm{\tau_{CB}}}
\end{align}
To limit our degree of freedom in the system, we have set a constraint for our quaternions, namely unit quaternion:
\begin{align}
  q_r^2 + q_i^2 + q_j^2 + q_k^2 = 1 \\
  q_r\dot{q_r} + q_i\dot{q_i} + q_j\dot{q_j} + q_k\dot{q_k} = 0\\
  q_r\ddot{q_r} + q_i\ddot{q_i} + q_j\ddot{q_j} + q_k\ddot{q_k} + \dot{q_r}^2 + \dot{q_i}^2 + \dot{q_j}^2 + \dot{q_k}^2 = 0
\end{align}
Last but not least, in the derivation below we use $\bm{q_\theta}$ directly for ease of typsetting, however, $q_{\theta}$ is not our state variable but $\theta$, their relationship is defined below
\begin{align*}
  \bm{q_\theta} &= \cos(\frac{\theta}{2}) + \sin(\frac{\theta}{2})R(\bm{q_{sys}})\prescript{B}{}{\bm{\hat{z_B}}} \\
  \bm{\dot{q}_\theta} &= -\frac{1}{2}\sin(\frac{\theta}{2})\dot{\theta} + \frac{1}{2}\cos(\frac{\theta}{2})\dot{\theta}R(\bm{q_{sys}})\prescript{B}{}{\bm{\hat{z_B}}} + \sin{(\frac{\theta}{2})}\dot{R(\bm{q_{sys}})} \prescript{B}{}{\bm{\hat{z_B}}}
\end{align*}
where $\prescript{B}{}{\bm{\hat{z_B}}} =
\begin{bmatrix}
    0\\ 0\\ 1
\end{bmatrix}
$
\subsubsection{Combining the Force equations}
\begin{align*}
  \shortintertext{From (1),}
  \prescript{O}{}{\bm{F_{CB}}} &= m_B \prescript{O}{}{\bm{a_B}} - \prescript{O}{}{\bm{F_{GB}}} - \prescript{O}{}{\bm{F_{T}}} \\
  \shortintertext{From (3),}
  \prescript{O}{}{\bm{F_{BC}}} &= m_C \prescript{O}{}{\bm{a_C}} - \prescript{O}{}{\bm{F_{GC}}} \\
  \shortintertext{Using (6),}
  m_B \prescript{O}{}{\bm{a_B}} + m_C \prescript{O}{}{\bm{a_C}} &= \prescript{O}{}{\bm{F_{GC}}} + \prescript{O}{}{\bm{F_{GB}}} + \prescript{O}{}{\bm{F_{T}}} 
\end{align*}
Simplifying the above expression, we get
\begin{equation}
    (m_b + m_c) \bm{\ddot{p}_{sys}} + m_c \ddot{R}(\bm{q_{sys}}) \prescript{B}{}{\bm{r_{BC}}} = \bm{F_{GC}} + \bm{F_{GB}} + \bm{F_{T}} 
\end{equation}
\subsubsection{Combining the Torqe equations}
\begin{align*}
  \shortintertext{From (2),}
  \prescript{O}{}{\bm{\tau_{CB}}} &= \prescript{O}{}{I_B} \prescript{O}{}{\bm{\alpha_B}} \\
  \shortintertext{From (4),}
  \prescript{O}{}{\bm{\tau_{BC}}} &= \prescript{O}{}{I_c} \prescript{O}{}{\bm{\alpha_C}} - \prescript{O}{}{\bm{\tau_{RF}}}  \\
  \shortintertext{Using (7),}
  \prescript{O}{}{I_B} \prescript{O}{}{\bm{\alpha_B}} + \prescript{O}{}{I_c} \prescript{O}{}{\bm{\alpha_C}} &= \prescript{O}{}{\bm{\tau_{RF}}} \\
\end{align*}  
Assuming all the vectors are represented in the inertial O frame, using the quaternion representation for angular acceleration,
\begin{equation}
  2I_B \left[\bm{\ddot{q}_B}\bm{q_B^*} - (\bm{\dot{q}_B} \bm{q_B^*})^2\right] + 2I_c \left[\bm{\ddot{q}_C}\bm{q_C^*} - (\bm{\dot{q}_C} \bm{q_C^*})^2\right] = \prescript{O}{}{\bm{\tau_{RF}}}
\end{equation}
Substituting (5)-(7) in the above expression and isolating second derivative on the left, we have
\begin{align}
  2 I_B [\bm{\ddot{q}_{sys}} \bm{q_{sys}^*}] + 2I_C [\bm{q_{\theta}}\bm{\ddot{q}_{sys}} (\bm{q_{\theta}} \bm{q_{sys}})^{\bm{*}}] + 2 I_C [\bm{\ddot{q}_{\theta}} \bm{q_{sys}}](\bm{q_{\theta}q_{sys}})^{\bm{*}} - \bm{r_{CB}} \times \bm{F_{BC}} = \zeta
\end{align}
where
\begin{align*}
  \zeta = 2I_B(\bm{\dot{q}_{sys}}\bm{q_{sys}^*})^2 + 2I_C[(\bm{q_\theta} \bm{\dot{q}_{sys}} + \bm{\dot{q}_\theta}\bm{q_{sys}})(\bm{q_{\theta}\bm{q_{sys}}})^{\bm{*}}]^2 - 4I_C(\bm{\dot{q}_{\theta}\dot{q}_{sys}} )(\bm{q_\theta q_{sys}})^{\bm{*}}
\end{align*}
Note that we put $\bm{\tau_{RF}}$ on the left hand side, this is because we can express $\bm{F_{BC}}$ in terms of $\bm{\ddot{p}_{sys}}$ from (1), a second derivative of positional state
\begin{align*}
  \bm{F_{BC}} = m_B \bm{\ddot{p}_{sys}} - \bm{F_{GB}} - \bm{F_{T}}
\end{align*}
\end{document}